(function(){const e=Module||this,t=e.T,a=t.I,n=t.F,o=window,s=e.URL_PATH,i=t.$(e.elmid),r="/home/web_user/retroarch/userdata";var l,u,c,p,m={},d="#emu-welcome-result",g=[];a.toArr(i.children,(e=>{m[t.attr(e,"class").replace("emu-","")]=e})),e.aspect=1.5,e.PopupOptions={},e.print=t=>e.CF("print",t),e.printErr=t=>e.CF("printErr",t),e.onRuntimeInitialized=()=>e.CF("RuntimeInitialized");var h=async(o,i,r)=>{let l=await t.FetchItem({url:s.root+o+"?"+t.time,key:n.LibKey+n.getname(o),store:e.isLocal?void 0:t.LibStore,process:e=>t.$("#emu-status").innerHTML=e,decode:!0,version:i,type:r});return a.u8buf(l)&&(l=a.decode(l)),a.blob(l)&&(l=await l.text()),a.str(l)&&"json"==r?JSON.parse(l):l},y=(e,a)=>t.FetchItem({url:s.cores+e,store:u.DB.system,process:e=>t.$("#emu-status").innerHTML=e,type:a}),v=e=>a.toArr(u.getPathList(e)).map((t=>`<li data-root="${t[0]}"><p data-root="${t[0]}">${t[0].replace(e,".")}</p><p data-root="${t[0]}">${t[1].timestamp.toLocaleTimeString()}</p></li>`)).join(""),w=e=>e.replace(/([A-Z]+?)/g,((e,t)=>t&&` ${t.toLowerCase()}`||"")),b=(e,...t)=>{let n,o=[],s="emu-"+e;return o.push(s),a.toArr(t,(e=>!a.bool(e)&&o.push(s+"-"+e)||(n=e))),t=null,e=null,n?o.map((e=>"."+e)).join(""):o.join(" ")},$="/home/web_user/retroarch/userdata/retroarch.cfg";a.assign(e.action,{async PlayNow(){c=new F("settings"),u=new f(t),a.defines(e,{DISK:u},1),u.SetDB({libjs:t.getStore("data-libjs"),roms:t.getStore("data-roms"),system:t.getStore("data-system"),bios:t.getStore("data-bios"),config:t.getStore("data-config"),userdata:t.getStore("data-userdata")}),u.DB[r]=u.DB.userdata;var n=async()=>{l=await h("cores.json",t.version,"json");let s=a.FormGet(e.JSURLINFO[1]||location.search),i=s.get("core")||s.get("system");a.none(o.emu_system)||(i=o.emu_system),i&&l[i]?(e.romName=s.get("game")||s.get("rom"),a.none(o.emu_rom)||(e.romName=o.emu_rom),e.coreName=i,e.coreInfo=l[i],e.CF("HtmlInstall")):e.CF("SelectCores"),n=null};e.JSpath.includes(location.host)?n():(t.$(d).innerHTML=`<div><button class="emu-game-start">${t.getLang("Play Now!")}</button></div>`,t.once(".emu-game-start","click",n))},async SelectCores(){let o='<ul class="emu-core-ul">',i={};var r=await t.FetchItem({url:s.root+"zip/system-icons.zip",store:u.DB.libjs,process:e=>t.$("#emu-status").innerHTML=e,version:t.version,unpack:!0});a.toArr(r,(e=>i[e[0]]=n.URL(e[1],n.getMime("png")))),t.null(r),r=null,a.toArr(l,(e=>{let[t,a]=e;o+=`<li class="emu-core-item" data-core="${t}">${a.sys&&i[a.sys+".png"]?`<img class="emu-core-img" src="${i[a.sys+".png"]}">`:`<p class="emu-core-sys">${a.name}</p>`}<p class="emu-core-name">${a.core}</p></li>`}));var c=o=>{var s=null,r=o.target;if(a.elm(r)&&r!=p){if(!(s=r.getAttribute("data-core")))return;t.un(p,"click",c),c=null,e.coreName=s,e.coreInfo=l[s],a.toArr(i,(e=>n.removeURL(e[1]))),t.null(i),i=null,e.CF("HtmlInstall")}},p=t.$(d);p.innerHTML=o+"</ul>",t.on(p,"click",c)},HtmlInstall(){var n;e.coreInfo=l[e.coreName],e.sysName=e.coreInfo.sys||e.coreName,p=new F("core-"+e.sysName),a.mobile&&e.CF("HtmlMobile"),t.$append(m.resume,t.$ct("div",t.getLang("Click to work"),"emu-resume-txt")),e.CF("HtmlSetting"),e.CF("HtmlDialog"),e.canvas=(n="canvas",t.$(n,i)),e.CF("loadCores")},HtmlSetting(){t.$append(m.settings,t.$ct("button",'<span class="emu-settings-icon"></span>',"emu-settings-btn"));var s=t.$append(m.settings,t.$ct("div","","emu-settings-ctrls")),i=t.$append(m.settings,t.$ct("div","","emu-settings-popup")),l=t.$append(t.$append(i,t.$ct("div","","emu-spopup-container")),t.$ct("div","","emu-spopup-item emu-spopup-item-home active"));t.on(t.$append(l,t.$ct("button",`<span class="${b("spopup-span","option")}">${t.getLang("close")}</span>`,b("spopup-btn","key"))),"pointerup",(t=>e.CF("ShowPopup","home",t,!0))),i.hidden=!0,a.toArr({restart(t){e._cmd_reset(),e.CF("CloseSetting")},loadState(){e._cmd_load_state(),e.CF("CloseSetting")},saveState(){e._cmd_save_state(),e.CF("CloseSetting")},autoSaves(){a.none(e.autoSavesTime)||clearInterval(e.autoSavesTime),t.$(".emu-settings-menu-autoSaves").classList.toggle("active")&&(e.autoSavesTime=setInterval((()=>{e._cmd_savefiles&&e._cmd_savefiles()}),1e4))},cheatCode(){e.CF("CloseSetting"),e.CF("ShowDialog","cheat")},showCache(){e.CF("CloseSetting"),e.CF("ShowDialog","cache")},setting(){e.CF("ShowPopup","home",null,!0)}},(e=>{let a=w(e[0]);t.on(t.$append(s,t.$ct("button",`<span>${t.getLang(a)}</span>`,"emu-settings-menu-item emu-settings-menu-"+e[0])),"pointerup",(t=>e[1](t)))})),e.CF("SetPopup",{myAction:{lable:"my action",options:["import state","import saves","toggle system"],default:null,callback(s){if(e.CF("CloseSetting"),"toggle system"==s)return e.CF("keyClick","menu_toggle");e.CF("upload",(async i=>{let l="import state",c=await t.unFile(i),p=s==l?".state":".srm";s!=l&&"nds"==e.sysName&&(p=".dsv"),a.u8buf(c)||(c=a.toArr(c).map((e=>new RegExp("\\"+p+"$").test(e[0])))[0]),c&&(u.MKFILE(r+"/"+(s==l?"states/":"saves/")+n.getKeyName(e.gameName)+p,c,1),s==l?e._cmd_load_state():o.confirm(t.getLang("unsupport load srm,it will write saves to reload page. are you sure?"))&&location.reload())}))}},volume:{lable:"set volume",options:["volume++","volume--","volume mute"],callback(t){switch(t){case"volume++":e.CF("keyClick","volume_up");break;case"volume--":e.CF("keyClick","volume_down");break;case"volume mute":e.CF("keyClick","audio_mute");break}return!0}}})},HtmlDialog(){a.toArr({cache(n,o){t.on(n,"opendialog",(async function(){this.hidden=!1;let e=`<h3>${t.getLang("Local Virtual File System")}</h3><ul class="fspath">${v(r+"/")}</ul>`;a.toArr(t.F.DataBase,(n=>{e+=`<h3>${t.getLang("Database Name:")}${n[0]}</h3><ul>`,a.toArr(n[1].objectStoreNames,(a=>e+=`<li><h6 data-name="${n[0]}" data-table="${a}">${t.getLang("Database Table:")}${a}</h6><ul></ul></li>`)),e+="</ul>"})),t.$(b("dialog-container","cache",!0)).innerHTML=e})),t.on(t.$(b("dialog-container",o,!0)),"click",(async function(n){let o=n.target,s=a.elmdata(o);if(s.name&&s.table){let n=t.getStore(s.table,s.name);if(s.downpath){let e=await n.data(s.downpath);a.obj(e)?(a.toArr(e,(e=>t.down(e[0],e[1]))),t.null(e)):t.down(t.F.getname(s.downpath),e),e=null}else if(s.removepath)o.parentNode.parentNode.remove(),await n.remove(s.removepath);else if(s.replacepath)a.toArr(s,(e=>o.removeAttribute(e[0]))),e.CF("upload",(async e=>{if(n==u.DB.system){let a=await n.get(s.replacepath);a.contents=await t.unFile(e,(e=>o.innerHTML=e)),await n.put(s.replacepath,a),o.innerHTML=t.getLang("OK!"),t.null(a),a=null}}),{accept:s.accept||""});else{let e=await n.keys(),i="";if(!e||!e.length)return o.nextElementSibling.innerHTML=`<p>${t.getLang("Empty")}</p>`;a.toArr(e,(e=>{let a="";n==u.DB.system&&(a=`<button data-replacepath="${e}" data-name="${s.name}" data-table="${s.table}" data-accept=".zip,.data,.7z">${t.getLang("Replace Core")}</button>`),i+=`<li><p>${t.F.getname(e)}<p><button data-removepath="${e}" data-name="${s.name}" data-table="${s.table}">${t.getLang("Delete data")}</button><button data-downpath="${e}" data-name="${s.name}" data-table="${s.table}">${t.getLang("Download data")}</button>${a}</li>`})),o.nextElementSibling.innerHTML=i}}else if(s.root){let e=u.FS,a=e.analyzePath(s.root).object.mode;e.isDir(a)?t.$(".fspath",this).innerHTML=v(s.root):e.isFile(a)&&t.down(t.F.getname(s.root),e.readFile(s.root))}}))},cheat(n,o){t.$(b("dialog-container",o,!0)).innerHTML=`<textarea class="${b("dialog-text",o)}"></textarea><p><button class="${b("dialog-btn","apply",o)}">${t.getLang("apply")}</button></p><p>${t.getLang("one line one code!")}</p>`,t.on(n,"keydown keyup keypress",(e=>t.stopProp(e)),{passive:!0}),t.on(n,"opendialog",(async function(){this.hidden=!1;let e=p.data.cheat;e&&(t.$(b("dialog-text",!0),this).value=e)})),t.on(b("dialog-btn","apply",o,!0),"click",(async n=>{let o=t.$(b("dialog-text","cheat",!0)).value;p.set({cheat:o});let s=o.trim().split("\n");e.cwrap("cmd_cheat_realloc","",["number"])(s.length),a.toArr(s,((t,a)=>{(t=t.trim())&&/^[\w\d\s]+$/.test(t)&&("gba"==e.sysName&&(t=t.replace(/^0(\d)/,"8$1")),e.cwrap("cmd_cheat_set_code","string",["number","string"])(a,t),e.cwrap("cmd_cheat_get_code_state","number",["number"])(a)||e.cwrap("cmd_cheat_toggle_index","string",["number"])(a))})),e.cwrap("cmd_cheat_apply_cheats","",[])()}))}},(a=>{let[n,o]=a,s=t.$append(m.dialog,t.$ct("div","",b("dialog-item",n)));s.hidden=!0,s.innerHTML=`<div class="${b("dialog-container",n)}"></div><div class="${b("dialog-footer",n)}"><button class="${b("dialog-btn","close",n)}">${t.getLang("close")}</button></div>`,t.on(t.$(b("dialog-btn","close",n,!0)),"click",(t=>e.CF("CloseDialog",n))),o(s,n)}))},HtmlMobile(){let e=(e,t,n)=>`<button class="emu-${n||"dp"}-btn" ${e?`data-key="${e}"`:""}>${t?a.str(t)?t:t():""}</button>`;t.$append(m.controls,t.$ct("div",(()=>{let t,n="",o=["up","down"];return a.toArr(["left","right"],(s=>{a.toArr(o,(a=>{n+=e(s+","+a),t||(n+=e(a))})),n+=e(s),t||(n+=e()),t=!0})),n}),"emu-dpad")),t.$append(m.controls,t.$ct("div",(()=>{let t="";return a.toArr(["x","y","a","b"],(a=>{t+=e(a,a.toUpperCase(),"ab")})),t}),"emu-xyab")),t.$append(m.controls,t.$ct("div",(()=>{let t="";return a.toArr(["l","r"],(a=>{t+=e(a,a.toUpperCase(),"lr")})),t}),"emu-lbrt")),t.$append(m.controls,t.$ct("div",(()=>{let t="";return a.toArr(["select","start"],(a=>{t+=e(a,a.toUpperCase(),"ss")})),t}),"emu-bottom"))},async HtmlWelcome(){var o=e.sysName,s=o+"-",i=t.$(d),r=t.$(".emu-wel-result",i),l=t.$(".emu-wel-menu",i),c=(t.$(".emu-wel-roms",i),t.$(".emu-wel-bios",i),t.$(".emu-wel-game",i)),p=(e,a)=>`<p class="emu-wel-p">${e}</p><button class="emu-wel-btn" data-path="${e}">${t.getLang(a)}</button>`,m=async(e,a,n)=>{var i=u.DB[n>1?"bios":"roms"],l=e.replace(s,"");t.$append(r,t.$ct("div",l+"  "+t.getLang("is write"))),a?a.length<=t.maxsize&&await i.setData(s+l,a,{system:o}):a=await i.data(s+l),u.MKFILE((n>1?"/system/":"")+l,a),n<2&&t.$append(c,t.$ct("li",p(l,"play this"),"emu-wel-li")),a=null};a.toArr({importRoms:"import roms",importDeRoms:"decompressed roms",importBios:"import bios",importDeBios:"decompressed bios"},((n,o)=>{let s=t.$append(l,t.$ct("button",t.getLang(n[1]),"emu-wel-menu-btn emu-wel-btn"));t.on(s,"pointerdown",(n=>(n=>{e.CF("upload",(async e=>{let o,s=t.$append(r,t.$ct("div",e.name));o=1==n||3==n?await t.unFile(e,(t=>s.innerHTML=e.name+":"+t)):a.U8(await e.arrayBuffer()),a.u8buf(o)?await m(e.name,o,n):(await a.Async(a.toArr(o).map((async e=>m(e[0],e[1],n)))),t.null(o)),e=null,o=null}))})(o)))})),a.toArr({roms:await u.DB.roms.keys({index:"system",Range:IDBKeyRange.only(o)}),bios:await u.DB.bios.keys({index:"system",Range:IDBKeyRange.only(o)})},((e,l)=>{let d="",g=t.$(".emu-wel-"+e[0],i);a.toArr(e[1],(e=>{e=e.replace(s,""),d+=`<li class="emu-wel-li">${p(e,"Write")}</li>`})),d?(g.innerHTML=d,t.on(g,"pointerup",(e=>(async(e,i)=>{let l=e.target,d=a.elmdata(l);if(d.path)m(d.path,null,i?2:1),l.parentNode.remove();else if(d.down){let e=n.getname(d.down);await t.FetchItem({url:d.down,key:s+e,store:u.DB[i?"bios":"roms"],dataOption:{system:o},success(a){u.MKFILE((i?"/system/":"")+e,a),t.$append(r,t.$ct("div",d.down+"  "+t.getLang("is write"))),i||t.$append(c,t.$ct("li",p(e,"play this")))}})}})(e,l)))):g.remove()})),t.on(c,"pointerup",(t=>{let o=t.target,s=a.elmdata(o);if(s.path)return e.romName=s.path,e.gameName=n.getname(e.romName),e.arguments[1]=e.gameName,e.CF("callMain")}))},SetPopup(n){let o=t.$(".emu-spopup-container",m.settings),s=t.$(".emu-spopup-item-home",m.settings),i=(e,a)=>a?`<span class="${b("spopup-span","key")}">${t.getLang(e)}</span><span class="${b("spopup-span","value")}">${a?t.getLang(a):""}</span>`:`<span class="${b("spopup-span","option")}">${t.getLang(e)}</span>`;a.toArr(n,(n=>{let r=n[1].lable||w(n[0]),l=t.$append(s,t.$ct("button",i(r,n[1].default),b("spopup-btn","key"))),u=t.$append(o,t.$ct("div","",b("spopup-item",n[0])));u.setAttribute("data-pane",n[0]),l.setAttribute("data-key",n[0]),t.on(l,"pointerup",(function(t){e.CF("ShowPopup",this,t)})),t.$append(u,t.$ct("h5",t.getLang(r),b("spopup-item-title"))),t.on(t.$append(u,t.$ct("button",i("back menu"),b("spopup-btn","option"))),"pointerup",(t=>e.CF("ShowPopup","home"))),a.toArr(n[1].options,(o=>{var s,r=n[1].noformat?o:w(o);a.str(o)?s=o:[s,r]=o;let l=t.$append(u,t.$ct("button",i(r),b("spopup-btn","option")));l.setAttribute("data-value",s),l.setAttribute("data-key",n[0]),t.on(l,"pointerup",(function(t){e.CF("ChangePopup",this,this,t)||e.CF("ShowPopup","home",t)}))}))})),a.assign(e.PopupOptions,n)},ShowPopup(e,n,o){let s=a.elm(e)?e.getAttribute("data-key"):e,i=t.$(".emu-spopup-item-"+s),r=t.$(".emu-settings-popup",m.settings),l=t.$(".emu-spopup-container",m.settings);if(o&&"home"==e&&!r.hidden)return void(r.hidden=!0);r.hidden=!1,i.classList.add("position"),"home"!=s&&t.$(".emu-spopup-item-"+s).classList.remove("active");var u=i.getBoundingClientRect();a.setStyle(l,{width:u.width+"px",height:u.height+"px"});let c=t.$$(".active",r);a.toArr(c,(e=>{e==i?i.classList.remove("position"):e.classList.remove("active")})),i.classList.add("active")},ChangePopup(n,o,s){let i=t.$(".emu-spopup-home",m.settings),r=a.elm(n)?n.getAttribute("data-key"):n,l=a.elm(o)?o.getAttribute("data-value"):o;if(e.PopupOptions[r]&&e.PopupOptions[r].callback)return e.PopupOptions[r].callback.call(t.$('[data-key="'+r+'"]',i),l)},ShowDialog(e){m.dialog.classList.add("active"),t.triger(t.$(b("dialog-item",e,!0)),"opendialog")},CloseDialog(e){m.dialog.classList.remove("active"),e?t.$(b("dialog-item",e,!0)).hidden=!0:a.toArr(m.dialog.children,(e=>e.hidden=!0))},CloseSetting(){m.settings.classList.remove("active")},async loadCores(){e.wasmBinary=await y(e.coreName+"_libretro.wasm");let t=await y(e.coreName+"_libretro.js","text"),n=await h("Fix.js",e.version);a.u8buf(n)&&(n=a.decode(n)),t+=n,new Function("Module",t)(e)},print(e){},printErr(a){var n;(n=a.match(/Video\s*@\s*(\d+)x(\d+)/))&&(e.videoWidth=n[1],e.videoHeight=n[2],t.triger(window,"resize"))},async RuntimeInitialized(){var o="";if(u.SetModule(e),u.FS.createPath("/",r,!0,!0),u.FS.mount(u,{},r),u.action["indexdb-sync"]=(e,t)=>{o=t.join("<br>")+"<br>"},await u.mountReady(),!e.FS.analyzePath($).exists){let a=await h("retroarch.cfg",e.version);o+=t.getLang("RetroArch Config Write:")+n.getname($)+"<br>",u.MKFILE($,a,1),a=null}if(a.toArr(await t.FetchItem({url:s.root+"zip/shader.zip",store:t.LibStore,unpack:!0}),(e=>{/\.glslp$/.test(e[0])&&g.push(e[0]),o+=t.getLang("FS Shader Write:")+e[0]+"<br>",u.MKFILE("/shader/"+e[0],e[1],1),e[1]=null})),a.toArr(await t.FetchItem({url:s.root+"zip/glui.zip",store:t.LibStore,unpack:!0}),(e=>{o+=t.getLang("FS UI Write:")+e[0]+"<br>",u.MKFILE("/home/web_user/retroarch/bundle/assets/glui/"+e[0],e[1],1),e[1]=null})),e.wasmBinary=null,delete e.wasmBinary,e.CF("Button_"+e.sysName),m.controls.classList.add("emu-sys-"+e.sysName),e.FS.createPath("/","system",!0,!0),e.romName)return e.gameName=n.getname(e.romName),e.arguments[1]=e.gameName,e.CF("callMain");o='<div class="emu-wel-menu"></div>\n<ul class="emu-wel-game"></ul>\n<ul class="emu-wel-bios"></ul>\n<ul class="emu-wel-roms"></ul>\n<ul class="emu-wel-result"></ul>'+o,t.$(d).innerHTML=o,m.welcome.scroll(0,0),t.$(".emu-wel-menu")&&e.CF("HtmlWelcome")},async callMain(){if(e.gameName){if(!e.FS.analyzePath(e.gameName).exists){if(!e.romName)return;u.MKFILE(e.gameName,await t.FetchItem({url:e.romName}),1)}e.RA.context=new window.AudioContext||window.webkitAudioContext,await e.RA.context.resume(),"running"!=e.RA.context.state?(m.resume.hidden=!1,t.once(m.resume,"click",(t=>{e.RA.context.resume().then((t=>{m.resume.hidden||(e.callMain(e.arguments),e.CF("BindEvent")),m.resume.hidden=!0}))}))):(e.callMain(e.arguments),e.CF("BindEvent"))}},resume(){e.RA.context||(e.RA.context=new window.AudioContext||window.webkitAudioContext),"running"!=e.RA.context.state&&(e.pauseMainLoop(),m.resume.hidden=!1)},BindEvent(){m.welcome.remove(),t.on(window,"resize",(t=>{e.videoWidth&&(clearTimeout(e.resizeTimer),e.resizeTimer=setTimeout((()=>{if(e.aspect=e.videoWidth/e.videoHeight,(e=>{let{width:t,height:n}=i.getBoundingClientRect();a.setStyle(i,{"--width":t+"px","--height":n+"px","--aspect-hw":1/e,"--aspect-wh":e})})(e.aspect),e.setCanvasSize){let{width:t,height:a}=e.canvas.getBoundingClientRect(),n=t>720?t:720;e.setCanvasSize(n,n*a/t),e.keyMap&&(e.CF("keyClick",e.keyMap.menu_toggle),setTimeout((()=>e.CF("keyClick",e.keyMap.menu_toggle)),500))}}),300))}));let n=t.$(".emu-settings-btn",m.settings);t.on(n,"pointerdown",(e=>{m.settings.classList.toggle("active")})),t.on(t.$(".emu-spopup-container",m.settings),"transitionend",(function(e){a.toArr(t.$$(".position",this),(e=>e.classList.remove("position")))})),t.on(document.body,"contextMenu",t.stopEvent),t.on(document.body,"keydown",t.stopEvent),t.on(document.body,"keyup",t.stopEvent),t.on(e.canvas,"contextMenu",t.stopEvent),g.length&&(g.unshift("remove"),e.CF("SetPopup",{setShader:{lable:"set shader",options:g,noformat:!0,callback(t){if(e.cwrap("cmd_set_shader","",["string"])("remove"==t?"":t),a.elm(this)){let e=this.getAttribute("data-key");c.set(a.toObj([[e,t]]))}e.CF("CloseSetting")}}}),c.data.setShader&&e.PopupOptions.setShader.callback(c.data.setShader)),t.on(m.resume,"click",(t=>{e.RA.context.resume().then((t=>{m.resume.hidden=!0,e.resumeMainLoop()}))})),t.on(document,"visibilitychange",(t=>{"visible"==document.visibilityState?e.resumeMainLoop():e.pauseMainLoop()})),e.CF("BindButton")},async BindButton(){if(await e.CF("keyInit"),m.welcome.remove(),m.screen.hidden=!1,m.settings.hidden=!1,m.dialog.hidden=!1,t.triger(window,"resize"),!a.mobile)return;m.controls.hidden=!1,t.stopGesture(m.controls);let n=t.$$("button",m.controls);e.touchlist=[],a.toArr(["touchstart","touchmove","touchend","touchcancel"],(o=>{n&&a.toArr(n,(e=>t.on(e,o,t.stopEvent))),t.on(m.controls,o,(n=>{let o=[];"touchstart"==n.type?o=e.touchlist.concat(e.CF("dataKey",n.target)):n.touches&&n.touches.length&&(o=a.toArr(n.touches).map((t=>e.CF("dataKey",document.elementFromPoint(t.pageX,t.pageY))))),o=o.length>0?o.join(",").split(",").filter((e=>e&&""!=e.trim())):[],o.join(",")!=e.touchlist&&(e.CF("keyChange",e.touchlist,o),e.touchlist=o),t.stopEvent(n)}),{passive:!1})}))},async keyInit(){if("undefined"==typeof codeToConfigIDMap&&await t.loadLibjs(s.assets+"charToCodeMap.js"),!e.keyMap){let t=a.decode(u.FS.readFile($));var n={};e.configData={},e.keyToCode||(e.keyToCode={},a.toArr(codeToConfigIDMap,(t=>{e.keyToCode[t[1]]=t[0]}))),t.split("\n").forEach((t=>{let a=t.match(/^(\w+)\s=\s("|')?(.+?)("|')?$/);if(a&&a[1]&&a[3])if(e.configData[a[1]]="false"!=a[3]&&("true"==a[3]||(isNaN(a[3])?a[3]:parseInt(a[3]))),/^input_player1_[a-z0-9]+?(.+?\_(minus|plus))?$/.test(a[1])){let t=a[1].replace("input_player1_","");n[t]=e.configData[a[1]]}else["input_load_state","input_save_state","input_menu_toggle","input_audio_mute","input_volume_down","input_volume_up"].includes(a[1])&&(n[a[1].replace("input_","")]=e.configData[a[1]])})),e.keyMap={},a.toArr(n,(t=>{e.keyMap[t[0]]=charToCodeMap[t[1]]||e.keyToCode[t[1]]&&{code:e.keyToCode[t[1]],key:t[1]}||t[1]}))}},keyChange(n,o){a.toArr([n,o],((n,o)=>a.array(n)&&a.toArr(n,(a=>{let n=t.$('[data-key="'+a+'"]',m.controls);n&&n.classList[1!=o?"remove":"add"]("active"),e.CF("keyEvent",a,0!==o)}))))},keyEvent(n,o){e.keyMap||e.CF("keyInit"),t.triger(document,a.R(18,o?"keydown":"keyup",a.str(n)?e.keyMap[n]:n))},keyClick(t){e.CF("keyEvent",t,!0),setTimeout((()=>e.CF("keyEvent",t,!1)),300)},dataKey(e){if(a.elm(e))return a.elmdata(e).key},Button_gba(){a.mobile&&a.toArr(["x","y"],(e=>t.$('[data-key="'+e+'"]',m.controls).remove()))},Button_n64(){a.mobile&&(t.$('[data-key="a"]',m.controls).innerHTML="↓",t.$('[data-key="b"]',m.controls).innerHTML="A",t.$('[data-key="x"]',m.controls).innerHTML="↑",t.$('[data-key="y"]',m.controls).innerHTML="B",t.$('[data-key="l"]',m.controls).innerHTML="←",t.$('[data-key="r"]',m.controls).innerHTML="→",t.$('[data-key="select"]',m.controls).innerHTML="Z",t.$('[data-key="select"]',m.controls).setAttribute("data-key","l2"),e.CF("Build_joystick",["l_x_minus","l_x_plus","l_y_minus","l_y_plus"],"joystick"))},async Build_joystick(a,n){t.nipplejs||await t.loadLibjs(s.root+"nipplejs.js");var i=t.$append(m.controls,t.$ce("div")),r=t.nipplejs.create({zone:i,mode:"static",position:{left:"50%",top:"50%"},color:"red"});o.kk=r,r.on("end",(function(t,n){e.CF("keyEvent",a[0],!1),e.CF("keyEvent",a[1],!1),e.CF("keyEvent",a[2],!1),e.CF("keyEvent",a[3],!1)})),r.on("move",(function(t,n){let{x:o,y:s}=n.vector;o>.4?(e.CF("keyEvent",a[0],!1),e.CF("keyEvent",a[1],!0)):Math.abs(o)>.4?(e.CF("keyEvent",a[0],!0),e.CF("keyEvent",a[1],!1)):(e.CF("keyEvent",a[0],!1),e.CF("keyEvent",a[1],!1)),s>.4?(e.CF("keyEvent",a[2],!0),e.CF("keyEvent",a[3],!1)):Math.abs(s)>.4?(e.CF("keyEvent",a[2],!1),e.CF("keyEvent",a[3],!0)):(e.CF("keyEvent",a[2],!1),e.CF("keyEvent",a[3],!1))})),i.classList.add("emu-"+n)},upload(e,n){let o=t.$ce("input");o.type="file",n&&a.toArr(n,(e=>o.setAttribute(e[0],e[1]))),o.onchange=t=>{let n=t.target.files;n&&n.length>0&&a.toArr(n,(t=>e(t))),o.remove()},o.click()}});class F{constructor(e){this.enabled=!0,this.key="emu_mobile_"+e;var t=window.localStorage.getItem(this.key);this.data=t?JSON.parse(t):{}}data={};get(e){return e?this.data[e]:this.data}set(e){e&&a.assign(this.data,e),window.localStorage.setItem(this.key,JSON.stringify(this.data))}}class f{constructor(e){let t=e.I;t.defines(this,{T:e,I:t},1),this.callaction=e.callaction}speed=1e3/60;action={};DB={};SetModule(e){let t=this;e&&t.I.defines(t,{Module:e},1),t.Module&&(t.MEMFS.stream_ops.write=function(e,a,n,o,s,i){if(t.HEAP8&&a.buffer===t.HEAP8.buffer&&(i=!1),!o)return 0;var r=e.node;if(r.timestamp=Date.now(),a.subarray&&(!r.contents||r.contents.subarray)){if(i)return r.contents=a.subarray(n,n+o),r.usedBytes=o,o;if(0===r.usedBytes&&0===s)return t.update(e),r.contents=new Uint8Array(a.subarray(n,n+o)),r.usedBytes=o,o;if(s+o<=r.usedBytes)return r.contents.set(a.subarray(n,n+o),s),o}if(t.MEMFS.expandFileStorage(r,s+o),r.contents.subarray&&a.subarray)r.contents.set(a.subarray(n,n+o),s);else for(var l=0;l<o;l++)r.contents[s+l]=a[n+l];return r.usedBytes=Math.max(r.usedBytes,s+o),o},t.MEMFS.ops_table&&(t.MEMFS.ops_table.file.stream.write=t.MEMFS.stream_ops.write))}SetDB(e){this.I.assign(this.DB,e)}get FS(){return this.Module.FS}get MEMFS(){return this.Module.MEMFS||this.FS.filesystems.MEMFS}get HEAP8(){return this.Module.HEAP8}getStore(e){let t=this.DB,a=e.mountpoint||e;return!!t[a]&&t[a]}mount(e){let t=this;t.FS.analyzePath(e.mountpoint).exists||t.FS.createPath("/",e.mountpoint,!0,!0);let a=e.mountpoint.split("/").length,n=t.MEMFS.createNode(a<3?t.FS.root:null,a<3?e.mountpoint.split("/").pop():e.mountpoint.replace(/^\//,""),16895,0);return t.getStore(e)&&(t.__mount||(t.__mount=[]),t.__mount.push(t.syncfs(e,(e=>t.callaction("DiskReadyOut",e))))),n}mountReady(){return Promise.all(this.__mount||[])}async syncfs(e,t,a){let n=this;t=a instanceof Function?a:t;let o,s=n.getStore(e);return o=e.isReady?await n.syncWrite(s,e):await n.writeToFS(s),e.isReady=!0,t instanceof Function&&t(o),o}async writeToFS(e){let t=this;return t.I.toArr(await e.all(!0)).map((e=>t.storeLocalEntry(e[0],e[1]))).join("\n")}async syncWrite(e,t){let a=this,n=a.I,o=t.isReady,s=a.getLocalSet(t),i=await a.getRemoteSet(e),r=(o?s:i).entries||{},l=(o?i:s).entries||{},u=await Promise.all(n.toArr(r).filter((e=>{if(!e[1])return"";let t=e[0],a=l[t];return!a||e[1].timestamp>a.timestamp})).map((e=>e[0])).sort().map((async t=>{if(o){let n=a.loadLocalEntry(t);if(n)return await e.put(t,n),"DB saved:"+t}else{let n=await e.get(t);if(n)return a.storeLocalEntry(t,n)}})));return u.concat(await Promise.all(n.toArr(l).filter((e=>{if(!e[1])return"";let t=r[e[0]];e[0];return!t||e[1].timestamp>t.timestamp})).map((e=>e[0])).sort().map((async t=>{let n="";return o?(await e.remove(t,!0),n="DB remove:"):(a.removeLocalEntry(t),n="FS remove:"),n+t})))),a.callaction("indexdb-sync",o,u),u.join("\n")}loadLocalEntry(e){let t,a,n=this,o=n.FS;return o.analyzePath(e).exists?(a=o.lookupPath(e).node,t=o.stat(e),o.isDir(t.mode)?{timestamp:t.mtime,mode:t.mode}:o.isFile(t.mode)?(a.contents=n.getFileDataAsTypedArray(a),{timestamp:t.mtime,mode:t.mode,contents:a.contents}):"node type not supported"):e+" is exists"}storeLocalEntry(e,t){let a=this.FS;if(a.isDir(t.mode))!a.analyzePath(e).exists&&a.createPath("/",e,!0,!0);else{if(!a.isFile(t.mode))throw"node type not supported";{let n=e&&e.split("/").slice(0,-1).join("/");n&&!a.analyzePath(n).exists&&a.createPath("/",n,!0,!0),a.writeFile(e,t.contents,{canOwn:!0,encoding:"binary"})}}return a.chmod(e,t.mode),a.utime(e,t.timestamp,t.timestamp),"FS write:"+e}removeLocalEntry(e){let t=this.FS;if(t.analyzePath(e).exists){var a=t.stat(e);return t.isDir(a.mode)?t.rmdir(e):t.isFile(a.mode)&&t.unlink(e),"FS unlink:"+e}return e+"is not exists"}async getRemoteSet(e,t){let a={type:"remote",store:e,entries:await e.cursor("timestamp",!0)};return t&&t(a),a}getLocalSet(e,t){if(!e)return;let a={type:"local",entries:this.getLocalList(e.mountpoint)};return t&&t(a),a}getLocalList(e){return this.getPathList(e,!0)}getPathList(e,t){if(!this.Module)return{};e=e||"/";let a=this,n=a.FS,o={},s=[".",".."].concat("/"==e?["dev","tmp","proc"]:[]),i=e=>!t||!s.includes(e),r=e=>t=>a.join2(e,t),l=a.stat(e)&&n.readdir(e).filter(i).map(r(e));if(l){for(;l.length;){let s=l.shift();if(!t&&s==e)continue;let u=a.stat(s);u&&(o[s]={timestamp:u.mtime},n.isDir(u.mode)&&t&&l.push.apply(l,n.readdir(s).filter(i).map(r(s))))}return o}}stat(e){let t=this.FS,a=t.analyzePath(e);if(a.exists&&a.object.node_ops&&a.object.node_ops.getattr)return t.stat(e)}getFileDataAsTypedArray(e){return e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array}join(){var e=Array.prototype.slice.call(arguments,0);return this.normalize(e.join("/"))}join2(e,t){return this.normalize(e+"/"+t)}normalize(e){var t="/"===e.charAt(0),a="/"===e.substring(-1);return(e=this.normalizeArray(e.split("/").filter((e=>!!e)),!t).join("/"))||t||(e="."),e&&a&&(e+="/"),(t?"/":"")+e}normalizeArray(e,t){for(var a=0,n=e.length-1;n>=0;n--){var o=e[n];"."===o?e.splice(n,1):".."===o?(e.splice(n,1),a++):a&&(e.splice(n,1),a--)}if(t)for(;a;a--)e.unshift("..");return e}updatePromise(e){let t=this;return new Promise(((a,n)=>{t.updateList.includes(e.node.mount)||t.updateList.push(e.node.mount);let o=setInterval((()=>{t.updateTime&&o!=t.updateTime&&(clearInterval(o),n("other update")),null!=e.fd&&null!=t.FS.streams[e.fd]||(clearInterval(o),a("ok"))}),t.speed);t.updateTime=o}))}updatePath=[];updateList=[];async updateMount(){let e=this;if(e.updateList.length){let t=e.updateList.map((async t=>e.syncfs(t,(e=>{}))));e.updateList=[],e.updatePath=[],await Promise.all(t)}}update(e){let t=this;t.getStore(e.node.mount)&&e.path&&null!=e.fd&&!t.updatePath.includes(e.path)&&(t.updatePath.push(e.path),t.updatePromise(e).then((e=>t.updateMount())))}ReadFile(e){if(this.FS.analyzePath(e).exists)return this.FS.readFile(e)}MKFILE(e,t,a){if(!this.Module)return;let n=this.FS,o=e.split("/");if(o=o.length?o.slice(0,-1).join("/"):"/",!n.analyzePath(o).exists){let e=o.split("/").slice(0,-1).join("/");n.analyzePath(e).exists||n.createPath("/",e,!0,!0),n.createPath("/",o,!0,!0)}"string"==typeof t&&(t=(new TextEncoder).encode(t)),a?(n.analyzePath(e).exists&&n.unlink(e),n.writeFile(e,t,{encoding:"binary"})):n.analyzePath(e).exists||n.writeFile(e,t,{encoding:"binary"})}}e.CF("PlayNow")}).call(Module);