const M=Module||this,T=M.T,I=T.I,F=T.F,W=window,ROOT=M.URL_PATH,ElmBody=T.$(M.elmid),USERPATH="/home/web_user/retroarch/userdata";var coreJson,DISK,StorageSetings,CoreSetings,ELMENTS={},resultID="#emu-welcome-result",shaderList=[];I.toArr(ElmBody.children,(e=>{ELMENTS[I.Attr(e,"class").replace("emu-","")]=e})),M.aspect=1.5,M.PopupOptions={},M.print=e=>M.CF("print",e),M.printErr=e=>M.CF("printErr",e),M.onRuntimeInitialized=()=>M.CF("RuntimeInitialized");var getText=async(e,t,a)=>{let o=await T.FetchItem({url:ROOT.root+e+"?"+T.time,key:F.LibKey+F.getname(e),store:M.isLocal?void 0:T.LibStore,process:e=>T.$("#emu-status").innerHTML=e,decode:!0,version:t,type:a});return I.u8buf(o)&&(o=I.decode(o)),I.blob(o)&&(o=await o.text()),I.str(o)&&"json"==a?JSON.parse(o):o},getCores=(e,t)=>T.FetchItem({url:ROOT.cores+e,store:DISK.DB.system,process:e=>T.$("#emu-status").innerHTML=e,type:t}),getFShtml=e=>I.toArr(DISK.getPathList(e)).map((t=>`<li data-root="${t[0]}"><p data-root="${t[0]}">${t[0].replace(e,".")}</p><p data-root="${t[0]}">${t[1].timestamp.toLocaleTimeString()}</p></li>`)).join(""),formatName=e=>e.replace(/([A-Z]+?)/g,((e,t)=>t&&` ${t.toLowerCase()}`||"")),formatClass=(e,...t)=>{let a,o=[],s="emu-"+e;return o.push(s),I.toArr(t,(e=>!I.bool(e)&&o.push(s+"-"+e)||(a=e))),t=null,e=null,a?o.map((e=>"."+e)).join(""):o.join(" ")},SetBody=e=>{let{width:t,height:a}=ElmBody.getBoundingClientRect();I.setStyle(ElmBody,{"--width":t+"px","--height":a+"px","--aspect-hw":1/e,"--aspect-wh":e})},$=e=>T.$(e,ElmBody),cfgpath="/home/web_user/retroarch/userdata/retroarch.cfg";I.assign(M.action,{async PlayNow(){StorageSetings=new storage("settings"),DISK=new NengeDisk(T),I.defines(M,{DISK:DISK},1),DISK.SetDB({libjs:T.getStore("data-libjs"),roms:T.getStore("data-roms"),system:T.getStore("data-system"),bios:T.getStore("data-bios"),config:T.getStore("data-config"),userdata:T.getStore("data-userdata")}),DISK.DB[USERPATH]=DISK.DB.userdata;var e=async t=>{coreJson=await getText("cores.json",T.version,"json");let a=I.FormGet(M.JSURLINFO[1]||location.search),o=a.get("core")||a.get("system");I.none(W.emu_system)||(o=W.emu_system),o&&coreJson[o]?(M.romName||(M.romName=a.get("game")||a.get("rom")),M.biosFile||(M.biosFile=a.get("bios")),I.none(W.emu_rom)||(M.romName=W.emu_rom),I.none(W.emu_bios)||(M.biosFile=W.emu_bios),M.coreName=o,M.coreInfo=coreJson[o],["true",!0].includes(M.biosFile)?M.coreInfo.bios?M.biosFile=M.coreInfo.bios.files:M.biosFile=null:M.biosFile&&(M.biosFile=I.str(M.biosFile)?T.split(M.biosFile):I.array(M.biosFile)?M.biosFile:null),M.CF("HtmlInstall")):M.CF("SelectCores"),e=null,t&&I.elm(t.target)&&t.target.remove()};M.JSpath.includes(location.host)?e():T.once(T.$append(ELMENTS.welcome,T.$ct("button",T.getLang("Play Now!"),"emu-game-start")),"click",e)},async SelectCores(){let e='<ul class="emu-core-ul">',t={};var a=await T.FetchItem({url:ROOT.root+"zip/system-icons.zip",store:DISK.DB.libjs,process:e=>T.$("#emu-status").innerHTML=e,version:T.version,unpack:!0});I.toArr(a,(e=>t[e[0]]=F.URL(e[1],F.getMime("png")))),T.null(a),a=null,I.toArr(coreJson,(a=>{let[o,s]=a;e+=`<li class="emu-core-item" data-core="${o}">${s.sys&&t[s.sys+".png"]?`<img class="emu-core-img" src="${t[s.sys+".png"]}">`:`<p class="emu-core-sys">${s.name}</p>`}<p class="emu-core-name">${s.core}</p></li>`}));var o=e=>{var a=null,n=e.target;if(I.elm(n)&&n!=s){if(!(a=n.getAttribute("data-core")))return;T.un(s,"click",o),o=null,M.coreName=a,M.coreInfo=coreJson[a],I.toArr(t,(e=>F.removeURL(e[1]))),T.null(t),t=null,M.CF("HtmlInstall")}},s=T.$(resultID);s.innerHTML=e+"</ul>",T.on(s,"click",o)},HtmlInstall(){M.coreInfo=coreJson[M.coreName],M.sysName=M.coreInfo.sys||M.coreName,CoreSetings=new storage("core-"+M.sysName),I.mobile&&M.CF("HtmlMobile"),T.$append(ELMENTS.resume,T.$ct("div",T.getLang("Click to work"),"emu-resume-txt")),M.CF("HtmlSetting"),M.CF("HtmlDialog"),M.canvas=$("canvas"),M.CF("loadCores")},HtmlSetting(){T.$append(ELMENTS.settings,T.$ct("button",'<span class="emu-settings-icon"></span>',"emu-settings-btn"));var e=T.$append(ELMENTS.settings,T.$ct("div","","emu-settings-ctrls")),t=T.$append(ELMENTS.settings,T.$ct("div","","emu-settings-popup")),a=T.$append(T.$append(t,T.$ct("div","","emu-spopup-container")),T.$ct("div","","emu-spopup-item emu-spopup-item-home active"));T.on(T.$append(a,T.$ct("button",`<span class="${formatClass("spopup-span","option")}">${T.getLang("Close Menu")}</span>`,formatClass("spopup-btn","key"))),"pointerup",(e=>M.CF("ShowPopup","home",e,!0))),t.hidden=!0,I.toArr({restart(e){M._cmd_reset(),M.CF("CloseSetting")},pause(e){M.CF("CloseSetting"),M.pauseMainLoop(),setTimeout((()=>{ELMENTS.resume.hidden=!1}),1e3)},loadState(){M._cmd_load_state(),M.CF("CloseSetting")},saveState(){M._cmd_save_state(),M.CF("CloseSetting")},autoSaves(){I.none(M.autoSavesTime)||clearInterval(M.autoSavesTime),T.$(".emu-settings-menu-autoSaves").classList.toggle("active")&&(M.autoSavesTime=setInterval((()=>{M._cmd_savefiles&&M._cmd_savefiles()}),1e4))},cheatCode(){M.CF("CloseSetting"),M.CF("ShowDialog","cheat")},showCache(){M.CF("CloseSetting"),M.CF("ShowDialog","cache")},setting(){M.CF("CloseSetting"),M.CF("ShowPopup","home",null,!0)}},(t=>{let a=formatName(t[0]);T.on(T.$append(e,T.$ct("button",`<span>${T.getLang(a)}</span>`,"emu-settings-menu-item emu-settings-menu-"+t[0])),"pointerup",(e=>t[1](e)))})),M.CF("SetPopup",{myAction:{lable:"my action",options:["import state","import saves","toggle system"],default:null,callback(e){if(M.CF("CloseSetting"),"toggle system"==e)return M.CF("keyClick","menu_toggle");M.CF("upload",(async t=>{let a="import state",o=await T.unFile(t),s=e==a?".state":".srm";e!=a&&"nds"==M.sysName&&(s=".dsv"),I.u8buf(o)||(o=I.toArr(o).map((e=>new RegExp("\\"+s+"$").test(e[0])))[0]),o&&(DISK.MKFILE(USERPATH+"/"+(e==a?"states/":"saves/")+F.getKeyName(M.gameName)+s,o,1),e==a?M._cmd_load_state():W.confirm(T.getLang("unsupport load srm,it will write saves to reload page. are you sure?"))&&location.reload())}))}},volume:{lable:"set volume",options:["volume++","volume--","volume mute"],callback(e){switch(e){case"volume++":M.CF("keyClick","volume_up");break;case"volume--":M.CF("keyClick","volume_down");break;case"volume mute":M.CF("keyClick","audio_mute");break}return!0}}})},HtmlDialog(){I.toArr({cache(e,t){T.on(e,"opendialog",(async function(){this.hidden=!1;let e=`<h3>${T.getLang("Local Virtual File System")}</h3><ul class="fspath">${getFShtml(USERPATH+"/")}</ul>`;I.toArr(T.F.DataBase,(t=>{e+=`<h3>${T.getLang("Database Name:")}${t[0]}</h3><ul>`,I.toArr(t[1].objectStoreNames,(a=>e+=`<li><h6 data-name="${t[0]}" data-table="${a}">${T.getLang("Database Table:")}${a}</h6><ul></ul></li>`)),e+="</ul>"})),T.$(formatClass("dialog-container","cache",!0)).innerHTML=e})),T.on(T.$(formatClass("dialog-container",t,!0)),"click",(async function(e){let t=e.target,a=I.elmdata(t);if(a.name&&a.table){let e=T.getStore(a.table,a.name);if(a.downpath){let t=await e.data(a.downpath);I.obj(t)?(I.toArr(t,(e=>T.down(e[0],e[1]))),T.null(t)):T.down(T.F.getname(a.downpath),t),t=null}else if(a.removepath)t.parentNode.parentNode.remove(),await e.remove(a.removepath);else if(a.replacepath)I.toArr(a,(e=>t.removeAttribute(e[0]))),M.CF("upload",(async o=>{if(e==DISK.DB.system){let s=await e.get(a.replacepath);s.contents=await T.unFile(o,(e=>t.innerHTML=e)),await e.put(a.replacepath,s),t.innerHTML=T.getLang("OK!"),T.null(s),s=null}}),{accept:a.accept||""});else{let o=await e.keys(),s="";if(!o||!o.length)return t.nextElementSibling.innerHTML=`<p>${T.getLang("Empty")}</p>`;I.toArr(o,(t=>{let o="";e==DISK.DB.system&&(o=`<button data-replacepath="${t}" data-name="${a.name}" data-table="${a.table}" data-accept=".zip,.data,.7z">${T.getLang("Replace Core")}</button>`),s+=`<li><p>${T.F.getname(t)}<p><button data-removepath="${t}" data-name="${a.name}" data-table="${a.table}">${T.getLang("Delete data")}</button><button data-downpath="${t}" data-name="${a.name}" data-table="${a.table}">${T.getLang("Download data")}</button>${o}</li>`})),t.nextElementSibling.innerHTML=s}}else if(a.root){let e=DISK.FS,t=e.analyzePath(a.root).object.mode;e.isDir(t)?T.$(".fspath",this).innerHTML=getFShtml(a.root):e.isFile(t)&&T.down(T.F.getname(a.root),e.readFile(a.root))}}))},cheat(e,t){T.$(formatClass("dialog-container",t,!0)).innerHTML=`<textarea class="${formatClass("dialog-text",t)}"></textarea><p><button class="${formatClass("dialog-btn","apply",t)}">${T.getLang("apply")}</button></p><p>${T.getLang("one line one code!")}</p>`,T.on(e,"keydown keyup keypress",(e=>T.stopProp(e)),{passive:!0}),T.on(e,"opendialog",(async function(){this.hidden=!1;let e=CoreSetings.data.cheat;e&&(T.$(formatClass("dialog-text",!0),this).value=e)})),T.on(formatClass("dialog-btn","apply",t,!0),"click",(async e=>{let t=T.$(formatClass("dialog-text","cheat",!0)).value;CoreSetings.set({cheat:t});let a=t.trim().split("\n");M.cwrap("cmd_cheat_realloc","",["number"])(a.length),I.toArr(a,((e,t)=>{(e=e.trim())&&/^[\w\d\s]+$/.test(e)&&("gba"==M.sysName&&(e=e.replace(/^0(\d)/,"8$1")),M.cwrap("cmd_cheat_set_code","string",["number","string"])(t,e),M.cwrap("cmd_cheat_get_code_state","number",["number"])(t)||M.cwrap("cmd_cheat_toggle_index","string",["number"])(t))})),M.cwrap("cmd_cheat_apply_cheats","",[])()}))}},(e=>{let[t,a]=e,o=T.$append(ELMENTS.dialog,T.$ct("div","",formatClass("dialog-item",t)));o.hidden=!0,o.innerHTML=`<div class="${formatClass("dialog-container",t)}"></div><div class="${formatClass("dialog-footer",t)}"><button class="${formatClass("dialog-btn","close",t)}">${T.getLang("Close Dialog")}</button></div>`,T.on(T.$(formatClass("dialog-btn","close",t,!0)),"click",(e=>M.CF("CloseDialog",t))),a(o,t)}))},HtmlMobile(){let e=(e,t,a)=>`<button class="emu-${a||"dp"}-btn" ${e?`data-key="${e}"`:""}>${t?I.str(t)?t:t():""}</button>`;T.$append(ELMENTS.controls,T.$ct("div",(()=>{let t,a="",o=["up","down"];return I.toArr(["left","right"],(s=>{I.toArr(o,(o=>{a+=e(s+","+o),t||(a+=e(o))})),a+=e(s),t||(a+=e()),t=!0})),a}),"emu-dpad")),T.$append(ELMENTS.controls,T.$ct("div",(()=>{let t="";return I.toArr(["x","y","a","b"],(a=>{t+=e(a,a.toUpperCase(),"ab")})),t}),"emu-xyab")),T.$append(ELMENTS.controls,T.$ct("div",(()=>{let t="";return I.toArr(["l","r"],(a=>{t+=e(a,a.toUpperCase(),"lr")})),t}),"emu-lbrt")),T.$append(ELMENTS.controls,T.$ct("div",(()=>{let t="";return I.toArr(["select","start"],(a=>{t+=e(a,a.toUpperCase(),"ss")})),t}),"emu-bottom"))},async HtmlWelcome(){var e=M.sysName,t=e+"-",a=T.$(resultID),o=T.$(".emu-wel-result",a),s=T.$(".emu-wel-menu",a),n=(T.$(".emu-wel-roms",a),T.$(".emu-wel-bios",a),T.$(".emu-wel-game",a)),i=(e,t,a,o)=>`<p class="emu-wel-p">${o||""}${e}</p><button class="emu-wel-btn" data-${a}="${e}">${T.getLang(t)}</button>`,r=(e,t)=>i(e,t,"path",""),l=async(a,s,i)=>{var l=DISK.DB[i>1?"bios":"roms"],u=a.replace(t,"");T.$append(o,T.$ct("div",u+"  "+T.getLang("is write"))),s?s.length<=T.maxsize&&await l.setData(t+u,s,{system:e}):s=await l.data(t+u),DISK.MKFILE((i>1?"/system/":"")+u,s),i<2&&T.$append(n,T.$ct("li",r(u,"play this"),"emu-wel-li")),s=null};I.toArr({importRoms:"import roms",importDeRoms:"decompressed roms",importBios:"import bios",importDeBios:"decompressed bios"},((e,t)=>{let a=T.$append(s,T.$ct("button",T.getLang(e[1]),"emu-wel-menu-btn emu-wel-btn"));T.on(a,"click",(e=>(e=>{M.CF("upload",(async t=>{let a,s=T.$append(o,T.$ct("div",t.name));a=1==e||3==e?await T.unFile(t,(e=>s.innerHTML=t.name+":"+e)):I.U8(await t.arrayBuffer()),I.u8buf(a)?await l(t.name,a,e):(await I.Async(I.toArr(a).map((async t=>l(t[0],t[1],e)))),T.null(a)),t=null,a=null}))})(t)))})),I.toArr({roms:await DISK.DB.roms.keys({index:"system",Range:IDBKeyRange.only(e)}),bios:await DISK.DB.bios.keys({index:"system",Range:IDBKeyRange.only(e)})},((s,u)=>{let m="",c=T.$(".emu-wel-"+s[0],a);I.toArr(s[1],(e=>{e=e.replace(t,""),m+=`<li class="emu-wel-li">${r(e,"Write")}</li>`})),"bios"==s[0]&&M.coreInfo.bios&&I.toArr(M.coreInfo.bios.files,(e=>{var a;s[1].includes(t+F.getname(e))||(m+=`<li class="emu-wel-li">${a=e,i(a,"download","down","BIOS:")}</li>`)})),m?(c.innerHTML=m,T.on(c,"pointerup",(a=>(async(a,s)=>{let i=a.target,u=I.elmdata(i);if(u.path)l(u.path,null,s?2:1),i.parentNode.remove();else if(u.down){let a=F.getname(u.down),l=u.down,m="";s&&(l=ROOT.bios+u.down,m="/system/",M.coreInfo.bios&&M.coreInfo.path&&(m+=M.coreInfo.path)),i.parentNode.remove(),await T.FetchItem({url:l,key:t+a,store:DISK.DB[s?"bios":"roms"],dataOption:{system:e},async success(e){let t=F.CheckExt(e);if("zip"==t&&M.coreInfo.extensions.includes(t)||["7z","rar"].includes(t)){let t=T.$append(o,T.$ce("div"));e=await F.unFile(e,(e=>t.innerHTML=a+" "+e))}I.u8buf(e)?DISK.MKFILE(m+a,e):I.toArr((e=>DISK.MKFILE(s?"/system/"+e[0]:F.gamename(e[0]),e[1]))),T.$append(o,T.$ct("div",u.down+"  "+T.getLang("is write"))),s||T.$append(n,T.$ct("li",r(a,"play this")))}})}})(a,u)))):c.remove()})),T.on(n,"pointerup",(e=>{let t=e.target,a=I.elmdata(t);if(a.path)return M.romName=a.path,M.gameName=F.getname(M.romName),M.arguments[1]=M.gameName,M.CF("callMain")}))},SetPopup(e){let t=T.$(".emu-spopup-container",ELMENTS.settings),a=T.$(".emu-spopup-item-home",ELMENTS.settings),o=(e,t)=>t?`<span class="${formatClass("spopup-span","key")}">${T.getLang(e)}</span><span class="${formatClass("spopup-span","value")}">${t?T.getLang(t):""}</span>`:`<span class="${formatClass("spopup-span","option")}">${T.getLang(e)}</span>`;I.toArr(e,(e=>{let s=e[1].lable||formatName(e[0]),n=T.$append(a,T.$ct("button",o(s,e[1].default),formatClass("spopup-btn","key"))),i=T.$append(t,T.$ct("div","",formatClass("spopup-item",e[0])));i.setAttribute("data-pane",e[0]),n.setAttribute("data-key",e[0]),T.on(n,"pointerup",(function(e){M.CF("ShowPopup",this,e)})),T.$append(i,T.$ct("h5",T.getLang(s),formatClass("spopup-item-title"))),T.on(T.$append(i,T.$ct("button",o("back menu"),formatClass("spopup-btn","option"))),"pointerup",(e=>M.CF("ShowPopup","home"))),I.toArr(e[1].options,(t=>{var a,s=e[1].noformat?t:formatName(t);I.str(t)?a=t:[a,s]=t;let n=T.$append(i,T.$ct("button",o(s),formatClass("spopup-btn","option")));n.setAttribute("data-value",a),n.setAttribute("data-key",e[0]),T.on(n,"pointerup",(function(e){M.CF("ChangePopup",this,this,e)||M.CF("ShowPopup","home",e)}))}))})),I.assign(M.PopupOptions,e)},ShowPopup(e,t,a){let o=I.elm(e)?e.getAttribute("data-key"):e,s=T.$(".emu-spopup-item-"+o),n=T.$(".emu-settings-popup",ELMENTS.settings),i=T.$(".emu-spopup-container",ELMENTS.settings);if(a&&"home"==e&&!n.hidden)return void(n.hidden=!0);n.hidden=!1,s.classList.add("position"),"home"!=o&&T.$(".emu-spopup-item-"+o).classList.remove("active");var r=s.getBoundingClientRect();I.setStyle(i,{width:r.width+"px",height:r.height+"px"});let l=T.$$(".active",n);I.toArr(l,(e=>{e==s?s.classList.remove("position"):e.classList.remove("active")})),s.classList.add("active")},ChangePopup(e,t,a){let o=T.$(".emu-spopup-home",ELMENTS.settings),s=I.elm(e)?e.getAttribute("data-key"):e,n=I.elm(t)?t.getAttribute("data-value"):t;if(M.PopupOptions[s]&&M.PopupOptions[s].callback)return M.PopupOptions[s].callback.call(T.$('[data-key="'+s+'"]',o),n)},ShowDialog(e){ELMENTS.dialog.classList.add("active"),T.triger(T.$(formatClass("dialog-item",e,!0)),"opendialog")},CloseDialog(e){ELMENTS.dialog.classList.remove("active"),e?T.$(formatClass("dialog-item",e,!0)).hidden=!0:I.toArr(ELMENTS.dialog.children,(e=>e.hidden=!0))},CloseSetting(){ELMENTS.settings.classList.remove("active")},async loadCores(){M.wasmBinary=await getCores(M.coreName+"_libretro.wasm");let e=await getCores(M.coreName+"_libretro.js","text"),t=await getText("Fix.js",M.version);I.u8buf(t)&&(t=I.decode(t)),e+=t,new Function("Module",e)(M)},print(e){},printErr(e){var t;(t=e.match(/Video\s*@\s*(\d+)x(\d+)/))&&(M.videoWidth=t[1],M.videoHeight=t[2],T.triger(window,"resize"))},async RuntimeInitialized(){if(DISK.SetModule(M),DISK.FS.createPath("/",USERPATH,!0,!0),DISK.FS.mount(DISK,{},USERPATH),DISK.action["indexdb-sync"]=(e,t)=>{t.join("\n")+"\n"},await DISK.mountReady(),!M.FS.analyzePath(cfgpath).exists){let e=await getText("retroarch.cfg",M.version);T.getLang("RetroArch Config Write:")+F.getname(cfgpath)+"\n",DISK.MKFILE(cfgpath,e,1),e=null}if(I.toArr(await T.FetchItem({url:ROOT.root+"zip/shader.zip",store:T.LibStore,unpack:!0}),(e=>{/\.glslp$/.test(e[0])&&shaderList.push(e[0]),T.getLang("FS Shader Write:")+e[0]+"\n",DISK.MKFILE("/shader/"+e[0],e[1],1),e[1]=null})),I.toArr(await T.FetchItem({url:ROOT.root+"zip/glui.zip",store:T.LibStore,unpack:!0}),(e=>{T.getLang("FS UI Write:")+e[0]+"\n",DISK.MKFILE("/home/web_user/retroarch/bundle/assets/glui/"+e[0],e[1],1),e[1]=null})),M.wasmBinary=null,delete M.wasmBinary,M.CF("Button_"+M.sysName),ELMENTS.controls.classList.add("emu-sys-"+M.sysName),M.FS.createPath("/","system",!0,!0),M.RA.context=new window.AudioContext||window.webkitAudioContext,M.romName)return M.CF("WriteRoms");T.$(resultID).innerHTML='<div class="emu-wel-menu"></div><ul class="emu-wel-game"></ul><ul class="emu-wel-bios"></ul><ul class="emu-wel-roms"></ul><ul class="emu-wel-result"></ul>',ELMENTS.welcome.scroll(0,0),T.$(".emu-wel-menu")&&M.CF("HtmlWelcome")},async WriteRoms(){if(!M.gameName||!M.FS.analyzePath(M.gameName).exists){let e=M.sysName,t=e+"-";if(M.romName){let a=F.getname(M.romName),o=await T.FetchItem({url:M.romName,key:t+a,store:T.LibStore,dataOption:{system:e},process(e){}}),s=F.CheckExt(o);("zip"==s&&M.coreInfo.extensions.includes(s)||["7z","rar"].includes(s))&&(o=await F.unFile(o,(e=>{}))),I.u8buf(o)?(DISK.MKFILE(a,o,1),M.gameName=a):I.toArr((e=>{let t=F.getname(e[0]),a=F.getExt(t);!/^\./.test(t)&&M.coreInfo.extensions.includes(a)&&(DISK.MKFILE(t,e[1],1),M.gameName=t)}))}I.array(M.biosFile)&&await I.Async(M.biosFile.map((async a=>{let o,s,n=F.getname(a);o=/^(http|blob)/.test(a)?a:ROOT.bios+a,s="/system/",M.coreInfo.bios&&M.coreInfo.path&&(s+=M.coreInfo.path),await T.FetchItem({url:o,key:t+n,store:DISK.DB.bios,dataOption:{system:e},async success(e){let t=F.CheckExt(e);("zip"==t&&M.coreInfo.extensions.includes(t)||["7z","rar"].includes(t))&&(e=await F.unFile(e,(e=>{}))),I.u8buf(e)?DISK.MKFILE(s+n,e):I.toArr((e=>DISK.MKFILE("/system/"+e[0],e[1])))}})}))),M.gameName&&(M.arguments[1]=M.gameName,"running"!=M.RA.context.state?T.on(T.$append(ELMENTS.welcome,T.$ct("button",T.getLang("Play Now"),"emu-game-start")),"click",(async e=>{await M.RA.context.resume(),M.CF("callMain")})):M.CF("callMain"))}},async callMain(){"running"!=M.RA.context.state?(ELMENTS.resume.hidden=!1,T.once(ELMENTS.resume,"click",(async e=>{await M.RA.context.resume(),M.callMain(M.arguments),M.CF("BindEvent"),ELMENTS.resume.hidden=!0}))):(ELMENTS.resume.hidden=!0,M.callMain(M.arguments),M.CF("BindEvent"))},resume(){M.RA.context||(M.RA.context=new window.AudioContext||window.webkitAudioContext),"running"!=M.RA.context.state&&(M.pauseMainLoop(),ELMENTS.resume.hidden=!1)},BindEvent(){ELMENTS.welcome.remove(),T.on(window,"resize",(e=>{M.videoWidth&&(clearTimeout(M.resizeTimer),M.resizeTimer=setTimeout((()=>{if(M.aspect=M.videoWidth/M.videoHeight,SetBody(M.aspect),M.setCanvasSize){let{width:e,height:t}=M.canvas.getBoundingClientRect(),a=e>720?e:720;M.setCanvasSize(a,a*t/e),M.keyMap&&(M.CF("keyClick",M.keyMap.menu_toggle),setTimeout((()=>M.CF("keyClick",M.keyMap.menu_toggle)),100))}}),300))}));let e=T.$(".emu-settings-btn",ELMENTS.settings);T.on(e,"click",(e=>{ELMENTS.settings.classList.toggle("active")})),T.on(T.$(".emu-spopup-container",ELMENTS.settings),"transitionend",(function(e){I.toArr(T.$$(".position",this),(e=>e.classList.remove("position")))})),T.on(document.body,"contextMenu",T.stopEvent),T.on(document.body,"keydown",T.stopEvent),T.on(document.body,"keyup",T.stopEvent),T.on(M.canvas,"contextMenu",T.stopEvent),shaderList.length&&(shaderList.unshift("remove"),M.CF("SetPopup",{setShader:{lable:"set shader",options:shaderList,noformat:!0,callback(e){if(M.cwrap("cmd_set_shader","",["string"])("remove"==e?"":e),I.elm(this)){let t=this.getAttribute("data-key");StorageSetings.set(I.toObj([[t,e]]))}M.CF("CloseSetting")}}}),StorageSetings.data.setShader&&M.PopupOptions.setShader.callback(StorageSetings.data.setShader)),T.on(ELMENTS.resume,"click",(e=>{M.RA.context.resume().then((e=>{ELMENTS.resume.hidden=!0,M.resumeMainLoop()}))})),T.on(M.RA.context,"statechange",(e=>{Module.CF("resume")})),T.on(document,"visibilitychange",(e=>{"visible"==document.visibilityState?M.resumeMainLoop():M.pauseMainLoop()})),M.CF("BindButton")},async BindButton(){if(await M.CF("keyInit"),ELMENTS.welcome.remove(),ELMENTS.screen.hidden=!1,ELMENTS.settings.hidden=!1,ELMENTS.dialog.hidden=!1,T.triger(window,"resize"),!I.mobile)return;ELMENTS.controls.hidden=!1,T.stopGesture(ELMENTS.controls);let e=T.$$("button",ELMENTS.controls),t=[];I.toArr(["touchstart","touchmove","touchend","touchcancel"],(a=>{e&&I.toArr(e,(e=>T.on(e,a,T.stopEvent))),T.on(ELMENTS.controls,a,(e=>{let a=[];"touchstart"==e.type?a=t.concat(M.CF("dataKey",e.target)):e.touches&&e.touches.length&&(a=I.toArr(e.touches).map((e=>M.CF("dataKey",document.elementFromPoint(e.pageX,e.pageY))))),a=a.length>0?a.join(",").split(",").filter((e=>e&&""!=e.trim())):[],a.join(",")!=t&&(M.CF("keyChange",t,a),t=a),T.stopEvent(e)}),{passive:!1})}))},async keyInit(){if("undefined"==typeof codeToConfigIDMap&&await T.loadLibjs(ROOT.assets+"charToCodeMap.js"),!M.keyMap){let t=I.decode(DISK.FS.readFile(cfgpath));var e={};M.configData={},M.keyToCode||(M.keyToCode={},I.toArr(codeToConfigIDMap,(e=>{M.keyToCode[e[1]]=e[0]}))),t.split("\n").forEach((t=>{let a=t.match(/^(\w+)\s=\s("|')?(.+?)("|')?$/);if(a&&a[1]&&a[3])if(M.configData[a[1]]="false"!=a[3]&&("true"==a[3]||(isNaN(a[3])?a[3]:parseInt(a[3]))),/^input_player1_[a-z0-9]+?(.+?\_(minus|plus))?$/.test(a[1])){let t=a[1].replace("input_player1_","");e[t]=M.configData[a[1]]}else["input_load_state","input_save_state","input_menu_toggle","input_audio_mute","input_volume_down","input_volume_up"].includes(a[1])&&(e[a[1].replace("input_","")]=M.configData[a[1]])})),M.keyMap={},I.toArr(e,(e=>{M.keyMap[e[0]]=charToCodeMap[e[1]]||M.keyToCode[e[1]]&&{code:M.keyToCode[e[1]],key:e[1]}||e[1]}))}},keyChange(e,t){I.toArr([e,t],((e,t)=>I.array(e)&&I.toArr(e,(e=>{let a=T.$('[data-key="'+e+'"]',ELMENTS.controls);a&&a.classList[1!=t?"remove":"add"]("active"),M.CF("keyEvent",e,0!==t)}))))},keyEvent(e,t){M.keyMap||M.CF("keyInit"),T.triger(document,I.R(18,t?"keydown":"keyup",I.str(e)?M.keyMap[e]:e))},keyClick(e){M.CF("keyEvent",e,!0),setTimeout((()=>M.CF("keyEvent",e,!1)),50)},dataKey(e){if(I.elm(e))return I.elmdata(e).key},Button_gba(){I.mobile&&I.toArr(["x","y"],(e=>T.$('[data-key="'+e+'"]',ELMENTS.controls).remove()))},Button_n64(){I.mobile&&(T.$('[data-key="a"]',ELMENTS.controls).innerHTML="↓",T.$('[data-key="b"]',ELMENTS.controls).innerHTML="A",T.$('[data-key="x"]',ELMENTS.controls).innerHTML="↑",T.$('[data-key="y"]',ELMENTS.controls).innerHTML="B",T.$('[data-key="l"]',ELMENTS.controls).innerHTML="←",T.$('[data-key="r"]',ELMENTS.controls).innerHTML="→",T.$('[data-key="select"]',ELMENTS.controls).innerHTML="Z",T.$('[data-key="select"]',ELMENTS.controls).setAttribute("data-key","l2"),M.CF("Build_joystick",["l_x_minus","l_x_plus","l_y_minus","l_y_plus"],"joystick"))},async Build_joystick(e,t){T.nipplejs||await T.loadLibjs(ROOT.root+"nipplejs.js");var a=T.$append(ELMENTS.controls,T.$ce("div")),o=T.nipplejs.create({zone:a,mode:"static",position:{left:"50%",top:"50%"},color:"red"});W.kk=o,o.on("end",(function(t,a){M.CF("keyEvent",e[0],!1),M.CF("keyEvent",e[1],!1),M.CF("keyEvent",e[2],!1),M.CF("keyEvent",e[3],!1)})),o.on("move",(function(t,a){let{x:o,y:s}=a.vector;o>.4?(M.CF("keyEvent",e[0],!1),M.CF("keyEvent",e[1],!0)):Math.abs(o)>.4?(M.CF("keyEvent",e[0],!0),M.CF("keyEvent",e[1],!1)):(M.CF("keyEvent",e[0],!1),M.CF("keyEvent",e[1],!1)),s>.4?(M.CF("keyEvent",e[2],!0),M.CF("keyEvent",e[3],!1)):Math.abs(s)>.4?(M.CF("keyEvent",e[2],!1),M.CF("keyEvent",e[3],!0)):(M.CF("keyEvent",e[2],!1),M.CF("keyEvent",e[3],!1))})),a.classList.add("emu-"+t)},upload(e,t){let a=T.$ce("input");a.type="file",t&&I.toArr(t,(e=>a.setAttribute(e[0],e[1]))),a.onchange=t=>{let o=t.target.files;o&&o.length>0&&I.toArr(o,(t=>e(t))),a.remove()},a.click()}});class storage{constructor(e){this.enabled=!0,this.key="emu_mobile_"+e;var t=window.localStorage.getItem(this.key);this.data=t?JSON.parse(t):{}}data={};get(e){return e?this.data[e]:this.data}set(e){e&&I.assign(this.data,e),window.localStorage.setItem(this.key,JSON.stringify(this.data))}}class NengeDisk{constructor(e){e&&e.Set(this)}speed=1e3/60;action={};DB={};SetModule(e){let t=this;e&&t.I.defines(t,{Module:e},1),t.Module&&(t.MEMFS.stream_ops.write=function(e,a,o,s,n,i){if(t.HEAP8&&a.buffer===t.HEAP8.buffer&&(i=!1),!s)return 0;var r=e.node;if(r.timestamp=Date.now(),a.subarray&&(!r.contents||r.contents.subarray)){if(i)return r.contents=a.subarray(o,o+s),r.usedBytes=s,s;if(0===r.usedBytes&&0===n)return t.update(e),r.contents=new Uint8Array(a.subarray(o,o+s)),r.usedBytes=s,s;if(n+s<=r.usedBytes)return r.contents.set(a.subarray(o,o+s),n),s}if(t.MEMFS.expandFileStorage(r,n+s),r.contents.subarray&&a.subarray)r.contents.set(a.subarray(o,o+s),n);else for(var l=0;l<s;l++)r.contents[n+l]=a[o+l];return r.usedBytes=Math.max(r.usedBytes,n+s),s},t.MEMFS.ops_table&&(t.MEMFS.ops_table.file.stream.write=t.MEMFS.stream_ops.write))}SetDB(e){this.I.assign(this.DB,e)}get FS(){return this.Module.FS}get MEMFS(){return this.Module.MEMFS||this.FS.filesystems.MEMFS}get HEAP8(){return this.Module.HEAP8}getStore(e){let t=this.DB,a=e.mountpoint||e;return!!t[a]&&t[a]}mount(e){let t=this;t.FS.analyzePath(e.mountpoint).exists||t.FS.createPath("/",e.mountpoint,!0,!0);let a=e.mountpoint.split("/").length,o=t.MEMFS.createNode(a<3?t.FS.root:null,a<3?e.mountpoint.split("/").pop():e.mountpoint.replace(/^\//,""),16895,0);return t.getStore(e)&&(t.__mount||(t.__mount=[]),t.__mount.push(t.syncfs(e,(e=>t.CF("DiskReadyOut",e))))),o}mountReady(){return Promise.all(this.__mount||[])}async syncfs(e,t,a){let o=this;t=a instanceof Function?a:t;let s,n=o.getStore(e);return s=e.isReady?await o.syncWrite(n,e):await o.writeToFS(n),e.isReady=!0,t instanceof Function&&t(s),s}async writeToFS(e){let t=this;return t.I.toArr(await e.all(!0)).map((e=>t.storeLocalEntry(e[0],e[1]))).join("\n")}async syncWrite(e,t){let a=this,o=a.I,s=t.isReady,n=a.getLocalSet(t),i=await a.getRemoteSet(e),r=(s?n:i).entries||{},l=(s?i:n).entries||{},u=await Promise.all(o.toArr(r).filter((e=>{if(!e[1])return"";let t=e[0],a=l[t];return!a||e[1].timestamp>a.timestamp})).map((e=>e[0])).sort().map((async t=>{if(s){let o=a.loadLocalEntry(t);if(o)return await e.put(t,o),"DB saved:"+t}else{let o=await e.get(t);if(o)return a.storeLocalEntry(t,o)}})));return u.concat(await Promise.all(o.toArr(l).filter((e=>{if(!e[1])return"";let t=r[e[0]];e[0];return!t||e[1].timestamp>t.timestamp})).map((e=>e[0])).sort().map((async t=>{let o="";return s?(await e.remove(t,!0),o="DB remove:"):(a.removeLocalEntry(t),o="FS remove:"),o+t})))),a.CF("indexdb-sync",s,u),u.join("\n")}loadLocalEntry(e){let t,a,o=this,s=o.FS;return s.analyzePath(e).exists?(a=s.lookupPath(e).node,t=s.stat(e),s.isDir(t.mode)?{timestamp:t.mtime,mode:t.mode}:s.isFile(t.mode)?(a.contents=o.getFileDataAsTypedArray(a),{timestamp:t.mtime,mode:t.mode,contents:a.contents}):"node type not supported"):e+" is exists"}storeLocalEntry(e,t){let a=this.FS;if(a.isDir(t.mode))!a.analyzePath(e).exists&&a.createPath("/",e,!0,!0);else{if(!a.isFile(t.mode))throw"node type not supported";{let o=e&&e.split("/").slice(0,-1).join("/");o&&!a.analyzePath(o).exists&&a.createPath("/",o,!0,!0),a.writeFile(e,t.contents,{canOwn:!0,encoding:"binary"})}}return a.chmod(e,t.mode),a.utime(e,t.timestamp,t.timestamp),"FS write:"+e}removeLocalEntry(e){let t=this.FS;if(t.analyzePath(e).exists){var a=t.stat(e);return t.isDir(a.mode)?t.rmdir(e):t.isFile(a.mode)&&t.unlink(e),"FS unlink:"+e}return e+"is not exists"}async getRemoteSet(e,t){let a={type:"remote",store:e,entries:await e.cursor("timestamp",!0)};return t&&t(a),a}getLocalSet(e,t){if(!e)return;let a={type:"local",entries:this.getLocalList(e.mountpoint)};return t&&t(a),a}getLocalList(e){return this.getPathList(e,!0)}getPathList(e,t){if(!this.Module)return{};e=e||"/";let a=this,o=a.FS,s={},n=[".",".."].concat("/"==e?["dev","tmp","proc"]:[]),i=e=>!t||!n.includes(e),r=e=>t=>a.join2(e,t),l=a.stat(e)&&o.readdir(e).filter(i).map(r(e));if(l){for(;l.length;){let n=l.shift();if(!t&&n==e)continue;let u=a.stat(n);u&&(s[n]={timestamp:u.mtime},o.isDir(u.mode)&&t&&l.push.apply(l,o.readdir(n).filter(i).map(r(n))))}return s}}stat(e){let t=this.FS,a=t.analyzePath(e);if(a.exists&&a.object.node_ops&&a.object.node_ops.getattr)return t.stat(e)}getFileDataAsTypedArray(e){return e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array}join(){var e=Array.prototype.slice.call(arguments,0);return this.normalize(e.join("/"))}join2(e,t){return this.normalize(e+"/"+t)}normalize(e){var t="/"===e.charAt(0),a="/"===e.substring(-1);return(e=this.normalizeArray(e.split("/").filter((e=>!!e)),!t).join("/"))||t||(e="."),e&&a&&(e+="/"),(t?"/":"")+e}normalizeArray(e,t){for(var a=0,o=e.length-1;o>=0;o--){var s=e[o];"."===s?e.splice(o,1):".."===s?(e.splice(o,1),a++):a&&(e.splice(o,1),a--)}if(t)for(;a;a--)e.unshift("..");return e}updatePromise(e){let t=this;return new Promise(((a,o)=>{t.updateList.includes(e.node.mount)||t.updateList.push(e.node.mount);let s=setInterval((()=>{t.updateTime&&s!=t.updateTime&&(clearInterval(s),o("other update")),null!=e.fd&&null!=t.FS.streams[e.fd]||(clearInterval(s),a("ok"))}),t.speed);t.updateTime=s}))}updatePath=[];updateList=[];async updateMount(){let e=this;if(e.updateList.length){let t=e.updateList.map((async t=>e.syncfs(t,(e=>{}))));e.updateList=[],e.updatePath=[],await Promise.all(t)}}update(e){let t=this;t.getStore(e.node.mount)&&e.path&&null!=e.fd&&!t.updatePath.includes(e.path)&&(t.updatePath.push(e.path),t.updatePromise(e).then((e=>t.updateMount())))}ReadFile(e){if(this.FS.analyzePath(e).exists)return this.FS.readFile(e)}MKFILE(e,t,a){if(!this.Module)return;let o=this.FS,s=e.split("/");if(s=s.length?s.slice(0,-1).join("/"):"/",!o.analyzePath(s).exists){let e=s.split("/").slice(0,-1).join("/");o.analyzePath(e).exists||o.createPath("/",e,!0,!0),o.createPath("/",s,!0,!0)}"string"==typeof t&&(t=(new TextEncoder).encode(t)),a?(o.analyzePath(e).exists&&o.unlink(e),o.writeFile(e,t,{encoding:"binary"})):o.analyzePath(e).exists||o.writeFile(e,t,{encoding:"binary"})}}M.CF("PlayNow");